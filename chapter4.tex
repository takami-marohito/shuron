\section{プログラム全体}
本研究で提案するHSIモデルの新しい構築手法について先の章で説明した。
この章ではその手法を実際にどのように実装したかについて説明する。

本研究では提案手法を3つのプログラムに分けて実装した。

\begin{itemize}
\item{流跡線計算プログラム}
\item{最適化計算プログラム}
\item{地図描画プログラム}
\end{itemize}

各プログラムについて次節から説明する。

\section{流跡線計算プログラム}
流跡線計算プログラムではルンゲクッタ法を用いた流跡線計算を行い、計算結果に沿ったサンプリングを行う。

なお本研究ではサンプリングを24時間ごとに行うようにし、流跡線計算を60日まで行う。
また、実測した漁獲点の中で、最も海底が浅い点の最大深さインデックスが20なので、深さごとの流跡線計算は深さインデックス20まで行う。

このプログラムでは60日分の流跡線計算をそれぞれの深さインデックス、それぞれの始点について順に行っている。
各点ごとの計算を順に行うので、始点情報を分割するだけで別の計算機による分散計算ができる。
本研究で使用する流跡線計算プログラムは次のようになっている。
\if0
ルンゲクッタ法のためにMOVEデータからデータを取り出すのが結構手間なことを説明する
\fi

\begin{enumerate}
\item{i=0にする}
\item{流跡線計算を行いたい始点の座標と日付を読み込む}
\item{次の4-14ステップをi=（流跡線計算を行いたい点の数）まで繰り返す}
\item{d=0にする}
\item{次の6-13ステップをd=20まで繰り返す}
\item{i番目の始点のd番目の深さインデックスの地点を流跡線計算の開始点にする。}
\item{t=0にする}
\item{次の9-12ステップをt=60まで繰り返す}
\item{tに対応する日付での3次元流速とt+1に対応する日付での3次元流速をMOVEデータから読み込む}
\item{ルンゲクッタ法を用いて24時間前の3次元座標を求める}
\item{t+1に対応する日付での各海洋環境変数をMOVEデータから読み込み、ステップ7で求めた座標での変数を補間し記録する}
\item{t=t+1にする}
\item{d=d+1にする}
\item{i=i+1にする}
\end{enumerate}

3章で説明したように、MOVEデータをOPeNDAPで取得する際に特定の深さでの水平な格子データが一度に取得できる。
そしてある深さでの値を補間するためにはその深さと隣接した2つの深さのデータから線形補間で計算を行う。
これを3次元それぞれの速度で行うので、ある点での流速を補間するためには6回のMOVEデータ取得が必要となる。
3章で説明したようにこのアルゴリズムでは一日前の流跡線を計算するためにルンゲクッタ法による流跡線計算を3回行っておりそれぞれの流速はMOVEデータから計算を行う。
MOVEデータは一日ごとに各格子点で流速が計算されいるので時間での補間は一日ごとの流速データから行う。
そのため、一日前の流跡線計算には合計12回のMOVEデータ取得が必要となる。
そのようにして求めた一日前の点で流速の他に海水温と塩分濃度の2種類の海洋環境変数を線形補間する。
そのため先の12回と合わせて合計16回のMOVEデータ取得を行うことで単一の点の一日前の各海洋環境変数の計算ができる。
単一の漁獲点ではこれを60日、20段階の深さインデックスについて行うので、単一の漁獲点から得られる海洋環境変数を全て計算するためには19200回のMOVEデータ取得が必要である。
本研究では合計で366点の観測データがあるので、すべての海洋環境変数の計算をするために702万7200回のMOVEデータ取得を行った。

\section{最適化計算プログラム}
最適化計算プログラムでは流跡線計算プログラムの結果を入力とし、HSIモデル構築に必要な各SIモデル式を計算する。

IRLSアルゴリズムで解くべき式は式\ref{eq:3-16-3}および式\ref{eq:3-17}である。
式\ref{eq:3-16-3}での各行列は次のように構成できる。
Yは$n \times 1$行列でそのi行目はi番目の漁獲点で実測した漁獲量となっている。
Xは$n \times m$行列でそのi行目はi番目の漁獲点の流跡線を計算することで得られる単一の海洋環境変数を全て横に並べた行列である。
$\lambda$は罰則項の重みである。
本研究では0から1まで0.01ごとに用意したそれぞれの$\lambda$の場合でモデルを計算し正答率が最大かつ最も$\lambda$が大きくなるモデルを最終的なモデルとして出力する。

最適化計算プログラムはmatlabで実装した。
IRLSアルゴリズムでは{\bf Ax}={\bf b}を満たす{\bf x}を計算する必要があるが、matlabではこれを計算する関数としてmldivide関数がある。
今回、{\bf Ax}={\bf b}に相当する方程式は式\ref{eq:3-16-3}となる。
この内、{\bf A}に相当する$X^{T}X + \lambda W^{(t)}$は$n \times n$行列となっている（nはモデル構築に使用する海洋環境変数の数）。
この場合、mldivide関数は$X^{T}X + \lambda W^{(t)}$を下三角行列{\bf L}と上三角行列{\bf U}に分解するLU分解を行うことで式\ref{eq:4-1}の変形をまず行う。

\begin{eqnarray}
\label{eq:4-1}
{\bf Ax} = {\bf LUx} = {\bf b}
\end{eqnarray}

式\ref{eq:4-1}は${\bf L}({\bf Ux}) = {\bf b}$ となり、これを{\bf Ux}について解く場合はちょうどガウスの消去法の前進消去となるので{\bf Ux}が求まる。
{\bf Ux}は同様にガウスの消去法の後退代入となるので、{\bf x}が求まる。
このようにすることで、{\bf Ax}={\bf b}から{\bf x}を求める場合、${\bf A}^{-1}$を求める必要はない。
つまり、式\ref{eq:3-16-3}を$\theta$について解く場合、$\left( X^{T}X + \lambda W^{(t)} \right) ^{-1}$を求める必要が無いということである。
以上のようにしてIRLSアルゴリズムでの$\theta$の更新を行っている。

最適化計算プログラム全体のアルゴリズムは次のようになっている。

\begin{enumerate}
\item{読み込んだ漁獲点を学習データとテストデータに分割する}
\item{$\lambda = 0$にする}
\item{次の4-7ステップを$\lambda = 1$まで繰り返す}
\item{IRLSアルゴリズムを用いてモデルを構築し係数行列$\theta$を求める}
\item{構築したモデルの正答率を求める}
\item{正答率がそれまでの最大正答率以上であれば$\theta$と$\lambda$と正答率を暫定的に保持する}
\item{$\lambda = \lambda+0.01$}
\item{最大正答率となる$\theta$と$\lambda$を出力する}
\end{enumerate}

これを各海洋環境変数ごとに行うことで各SIモデルを構築できる。
このようにして構築したSIモデルを次の地図描画プログラムに送ることで漁獲モデルによる予測の分布が可視化できる。
このプログラムでは各SIモデル構築を独立して行うことができるので、別の計算機を用いた分散計算が可能となっている。

\section{地図描画プログラム}
地図描画プログラムでは最適化計算プログラムの結果として得られた係数行列$\theta$を基にHSIモデルを構築し、地図に描画することで可視化を行う。
そのため、漁獲量予測を行い、その正答率を求めて評価する部分はこのプログラムが担当している。

最適化計算プログラムですでに各SIモデルが構築できているので、3章で説明したようにそれらの相乗平均をとることでHSIモデルを構築する。
そしてその評価を行うために3章で説明した正答率をこのHSIモデルに対して求める。

構築したHSIモデルは3章で説明した手順でCPUEの予測として可視化する。
本研究では過去の関連研究\cite{a7} \cite{related3} \cite{related5}と同様に、地図の海の部分を色分けすることで可視化した。
また、そのカラーマップも過去の関連研究\cite{related5}と同様に、青→緑→赤の順に予測したCPUEが大きくなるように設定する。
この色の変化を実現するためにHSL色空間に基づいたカラーマップを用いた。
HSL色空間は色相(Hue)彩度(Saturation）輝度(Lightness）を成分とする色空間である。
色相は0から360度までの角度で色合いを表し、彩度は0から100\% で色の鮮やかさを表し、輝度は0から100\% で色の明るさを表している。
この中で、色相は0度から順に変化させることで赤→緑→青→紫→赤までなめらかに変化する。
そのため彩度と輝度を一定にしたまま色相を240度から0度まで変化させることで青→緑→赤の色の変化を線形に表現できる。
本研究では純色で表すために彩度を100\% 、輝度を50\% とした。
またCPUEの予測と色相の変換は次式で行った。

\begin{eqnarray}
Hue = 240 \cdot \left( 1 - \frac{CPUE - CPUE_{min}}{CPUE_{max}-CPUE_{min}} \right)
\end{eqnarray}

構築したHSIモデルの分布を描画するためにはある程度の範囲で流跡線計算とサンプリングを行った点が必要である。
しかし、流跡線計算はまだ実測した漁獲点上でしか行っていない。
そのため分布を描画したい範囲を格子状に区切りその頂点を記録する。
それらを始点として、先の流跡線計算プログラムで流跡線計算と流跡線上でのサンプリングを予め行う。
こうすることで利用者にとっての最終結果であるCPUE予測の分布を可視化できる。