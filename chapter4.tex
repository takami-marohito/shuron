\section{プログラム全体}
本研究で提案するHSIモデルの新しい構築手法について先の章で説明した。
この章ではその手法を実際にどのように実装したかについて説明する。

本研究では提案手法を3つのプログラムに分けて実装した。

\begin{itemize}
\item{流跡線計算プログラム}
\item{最適化計算プログラム}
\item{地図描画プログラム}
\end{itemize}

各プログラムについて次節から説明する。

\section{流跡線計算プログラム}
流跡線計算プログラムではルンゲクッタ法を用いた流跡線計算を行い、計算結果に沿ったサンプリングを行う。

なお本研究ではサンプリングを24時間ごとに行うようにし、流跡線計算を60日まで行う。
また、実測した漁獲点の中で、最も海底が浅い点の最大深さインデックスが20なので、深さごとの流跡線計算は深さインデックス20まで行う。

このプログラムでは60日分の流跡線計算をそれぞれの深さインデックス、それぞれの始点について順に行っている。
各点ごとの計算を順に行うので、始点情報を分割するだけで別の計算機による分散計算ができる。
本研究で使用する流跡線計算プログラムは次のようになっている。

\begin{enumerate}
\item{i=0にする}
\item{流跡線計算を行いたい始点の座標と日付を読み込む}
\item{次の4-14ステップをi=（流跡線計算を行いたい点の数）まで繰り返す}
\item{d=0にする}
\item{次の6-13ステップをd=20まで繰り返す}
\item{i番目の始点のd番目の深さインデックスの地点を流跡線計算の開始点にする。}
\item{t=0にする}
\item{次の9-12ステップをt=60まで繰り返す}
\item{tに対応する日付での3次元流速とt+1に対応する日付での3次元流速をMOVEデータから読み込む}
\item{ルンゲクッタ法を用いて24時間前の3次元座標を求める}
\item{t+1に対応する日付での各海洋環境変数をMOVEデータから読み込み、ステップ7で求めた座標での変数を補間し記録する}
\item{t=t+1にする}
\item{d=d+1にする}
\item{i=i+1にする}
\end{enumerate}

\section{最適化計算プログラム}
最適化計算プログラムでは流跡線計算プログラムの結果を入力とし、HSIモデル構築に必要な各SIモデル式を計算する。

IRLSアルゴリズムで解くべき式は式\ref{eq:3-16-3}および式\ref{eq:3-17}である。
式\ref{eq:3-16-3}での各行列は次のように構成できる。
Yは$n \times 1$行列でそのi行目はi番目の漁獲点で実測した漁獲量となっている。
Xは$n \times m$行列でそのi行目はi番目の漁獲点の流跡線を計算することで得られる単一の海洋環境変数を全て横に並べた行列である。
$\lambda$は罰則項の重みである。
本研究では0から1まで0.01ごとに用意したそれぞれの$\lambda$の場合でモデルを計算し正答率が最大となるモデルを最終的なモデルとして出力する。

最適化計算プログラムはmatlabで実装した。
IRLSアルゴリズムでは{\bf Ax}={\bf b}を満たす{\bf x}を計算する。
matlabではこれを計算する関数としてmldivide関数がある。
\if0
mldivide関数の説明
特に今回のだと、どうやって逆行列を求めているか
\fi
そのアルゴリズムは次のようになっている。

\begin{enumerate}
\item{読み込んだ漁獲点を学習データとテストデータに分割する}
\item{$\lambda = 0$にする}
\item{次の4-7ステップを$\lambda = 1$まで繰り返す}
\item{IRLSアルゴリズムを用いてモデルを構築し係数行列$\theta$を求める}
\item{構築したモデルの正答率を求める}
\item{正答率がそれまでの最大正答率以上であれば$\theta$と$\lambda$と正答率を暫定的に保持する}
\item{$\lambda = \lambda+0.01$}
\item{最大正答率となる$\theta$と$\lambda$を出力する}
\end{enumerate}

これを各海洋環境変数ごとに行うことで各SIモデルを構築できる。
このようにして構築したSIモデルを次の地図描画プログラムに送ることで漁獲モデルによる予測の分布が可視化できる。
このプログラムでは各SIモデル構築を独立して行うことができるので、別の計算機を用いた分散計算が可能となっている。

\section{地図描画プログラム}
地図描画プログラムでは最適化計算プログラムの結果として得られた係数行列$\theta$を基にHSIモデルを構築し、地図に描画する。
そのため、漁獲量予測を行い、その正答率を求めて評価するのはこのプログラムで行っている。
\if0
カラーマップにHSLの0から180を使っていることを書く
\fi