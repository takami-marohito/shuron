本章では，データの計算法や従来のHSIモデル構築手法及び提案するHSIモデル構築手法などの基礎技術について述べる。

\section{使用データ}\label{30}
HSI値を求めるためには海洋環境変数データ、対象魚種の漁獲実績データが必要となる。
本研究で使用したこれらのデータについて述べる。

\subsection{海洋環境変数データ}
本研究で使用する海洋環境変数データは、気象庁気象研究所で開発された海洋データ同化システムで作成されたMOVE（MRI Multivariate Ocean Variational Estimation）データである。
この海洋データ同化システムは数値海洋モデル及び同化システムから成るシステムである\cite{a5}。
気象研究所共用海洋モデルMRI.COM\cite{a26}を用いて計算したシミュレーションデータと実測データを同化することでMOVEデータは計算された。
MOVEデータでは海水温、塩分濃度、3次元方向の流速が緯度経度$0.1^\circ$ ごとに計算されている。
また、深さは全54段階で最大6000mまで計算されている。
MOVEデータへのアクセスはOPeNDAPプロトコル\cite{a27}を用いている。
OPeNDAPはHTTP経由でデータアクセスを行うためのプロトコルであり地球科学の分野でよく使われる。
本研究で利用するMOVEデータの場合は変数名、日付番号、深さインデックス、緯度経度の配列範囲を指定しリクエストすることで、緯度経度の配列番号と実際の緯度経度の対応、指定範囲の変数データなどが返ってくる。

\if
海洋環境変数データの説明
変数が5種
深さは54段階
格子の縦横
データがカバーする緯度範囲経度範囲
いつだれがどんな計算機で計算したか
\fi

\subsection{過去のデータの計算}
本研究では過去の海洋環境変数を利用することを提案している。
ある地点での漁獲を過去の海洋環境変数から説明する場合その地点と海洋環境変数の間に時空間的な繋がりがあると考えられる。
そのためその地点の海水がどこから来たものなのか計算し、その経路上でサンプリングした海洋環境変数のみを使用するべきである。
\if0
双見君の研究でその必要性を説明している
\fi
本研究で使用する海洋環境データは3次元方向の速度も含んでいるので、海水を遡って計算することができる。
そして深さごとに異なる速度を持っているので、それぞれの深さをスタート地点として遡ると全く別の地点にたどり着く。
\if0
moveデータのダウンロードの仕様（日にちと深さを指定する）を説明して、遡るために何度もダウンロードする必要があることと、そのために事前計算とするひつようがあることをせつめいする。
\fi
今回はより正確に過去の地点を遡るために４次のルンゲクッタ法を用いた。

\subsection{ルンゲクッタ法}
ルンゲクッタ法は常微分方程式の数値解を求める手法の一種である。
同じように常微分方程式の数値解を求める手法として、オイラー法がある。
海洋環境変数を使用することである地点から流れを遡る場合、その地点の速度にステップの時間幅をかけることで過去の地点を求める手法がオイラー法である（式\ref{eq:3-20}）。

\begin{eqnarray}
\label{eq:3-20}
(x^{(t-1)}, y^{(t-1)}, z^{(t-1)}) = (x^t , y^t , z^t) - (u^t , v^t , w^t) \cdot \Delta t
\end{eqnarray}

遡っているので速度が負になっている。
オイラー法では速度はそのままその地点の速度を用いて、ステップの時間幅で速度変化がないものとして扱っている。
しかし、実際には微小時間ごとに速度変化は起きている。
ルンゲクッタ法はオイラー法の式である式\ref{eq:3-20}における$u^t$と$v^t$と$w^t$をより正確に求める手法である。
そのため、速度変化が一切ない領域ではどちらの手法も同じ結果となるが、本研究で使用する海洋環境変数データはそのような領域がないため、ルンゲクッタ法による精度向上が期待できる。

4次のルンゲクッタ法は次のように計算する。

\begin{enumerate}
\item k1からk4を計算する
\item k1からk4を重みを付けて平均化する
\item それを速度としてステップの時間幅$\Delta t$をかけることで、移動量とする
\item もとの位置に移動量を足すことで解とする
\end{enumerate}

k1は式\ref{eq:3-21}で計算する。

\begin{eqnarray}
\label{eq:3-21}
k1 = {\bf f} ({\bf X}, t)
\end{eqnarray}

ただし${bf X} = (x,y,z)$であり、${\bf f} ({\bf X}, t)$は時刻$t$、座標(x,y,z)における速度ベクトルである。

k2は式\ref{eq:3-22}で計算する。

\begin{eqnarray}
\label{eq:3-22}
k2 = {\bf f} ({\bf X} + k1\frac{\Delta t}{2} , t-\frac{\Delta t}{2})
\end{eqnarray}

${bf X} + \frac{\Delta t}{2} k1 = (x + \frac{\Delta t}{2} k1_u ,y+ \frac{\Delta t}{2} k1_v ,z+ \frac{\Delta t}{2} k1_w )$であり、${\bf f} ({\bf X} + \frac{\Delta t}{2} k1, t-\frac{\Delta t}{2})$は時刻$t-\frac{\Delta t}{2}$、座標$ (x + \frac{\Delta t}{2} k1_u ,y+ \frac{\Delta t}{2} k1_v ,z+ \frac{\Delta t}{2} k1_w )$における速度ベクトルである。

k3は式\ref{eq:3-23}で計算する。

\begin{eqnarray}
\label{eq:3-23}
k3 = {\bf f} ({\bf X} + k2\frac{\Delta t}{2} , t-\frac{\Delta t}{2})
\end{eqnarray}

k4は式\ref{eq:3-24}で計算する。

\begin{eqnarray}
\label{eq:3-24}
k4 = {\bf f} ({\bf X} + k3\Delta t , t-\Delta t)
\end{eqnarray}

k1からk4を用いて、ステップ時間前の座標は次式のようになる。

\begin{eqnarray}
\label{eq:3-25}
{\bf X}^{(t-1)} = {\bf X}^{t} - \frac{\Delta t}{6} (k1 + 2k2 + 2k3 + k4)
\end{eqnarray}

本研究ではより正確に流跡線計算を行うために、8時間ごと（一日に3回）にルンゲクッタ法で流跡線計算を行う。
この場合、式\ref{eq:3-22}、式\ref{eq:3-23}、式\ref{eq:3-24}、式\ref{eq:3-25}での$\Delta t$は$\frac{1}{3}$になり、これを3回計算することで一日分の流跡線が計算できる。

このようにして計算した流跡線上で海洋環境変数を一日ごとにサンプリングする。
サンプリングは線形補間で行う。
今回は3次元の座標$(x,y,z)$での海洋環境変数値$P(x,y,z)$を線形補間するので近傍の8点$(X_{i},Y_{i},Z_{i})$，$(X_{i+1},Y_{i},Z_{i})$，$(X_{i},Y_{i+1},Z_{i})$，
$(X_{i+1},Y_{i+1},Z_{i})$，$(X_{i},Y_{i},Z_{i+1})，
(X_{i+1},Y_{i},Z_{i+1})，(X_{i},Y_{i+1},Z_{i+1})，
(X_{i+1},Y_{i+1},Z_{i+1})$とそこでの海洋環境変数値$P(X,Y,Z)$を使って次の式で補間できる。

\begin{eqnarray}
\label{eq:3-99}
P_{y-z-} = P(X_{i},Y_{i},Z_{i}) + \frac{x-X_{i}}{X_{i+1}-X_{i}} \left( P(X_{i+1},Y_{i},Z_{i}) - P(X_{i},Y_{i},Z_{i})\right) \nonumber \\
P_{y+z-} = P(X_{i},Y_{i+1},Z_{i}) + \frac{x-X_{i}}{X_{i+1}-X_{i}} \left( P(X_{i+1},Y_{i+1},Z_{i}) - P(X_{i},Y_{i+1},Z_{i}) \right) \nonumber \\
P_{z-} = P_{y-z-} + \frac{y-Y_{i}}{Y_{i+1}-Y_{i}} \left( P_{y+z-} - P_{y-z-} \right) \nonumber \\
P_{y-z+} = P(X_{i},Y_{i},Z_{i+1}) + \frac{x-X_{i}}{X_{i+1}-X_{i}} \left( P(X_{i+1},Y_{i},Z_{i+1}) - P(X_{i},Y_{i},Z_{i+1})\right) \nonumber \\
P_{y+z+} = P(X_{i},Y_{i+1},Z_{i+1}) + \frac{x-X_{i}}{X_{i+1}-X_{i}} \left( P(X_{i+1},Y_{i+1},Z_{i+1}) - P(X_{i},Y_{i+1},Z_{i+1}) \right) \nonumber \\
P_{z+} = P_{y-z+} + \frac{y-Y_{i}}{Y_{i+1}-Y_{i}} \left( P_{y+z+} - P_{y-z+} \right) \nonumber \\
P(x,y,z) = P_{z-} + \frac{z-Z_{i}}{Z_{i+1}-Z_{i}} \left( P_{z+} - P_{z-} \right) \nonumber 
\end{eqnarray}

ルンゲクッタ法で補間を行う場合はさらに時間の補間も必要となる。
これも先の式と同様にして次式で計算できる。

\begin{eqnarray}
P(x,y,z,t) = P(x,y,z,T_{i}) + \frac{t-T_{i}}{T_{i+1}-T_{i}} \left( P(x,y,z,T_{i+1}) - P(x,y,z,T_{i}) \right)
\end{eqnarray}

\if0
MOVEデータの仕様を説明して、何回データをダウンロードするかとか書ける
\fi

\subsection{漁獲実績データ}
本研究で使用する漁獲実績データは、日本近海の太平洋沖におけるアカイカの漁獲実績データある。
漁獲実績データには日付、緯度、経度、漁獲量、操業開始時間、操業終了時間、CPUE（Catch Per Unit Effort）値が記録されている。
CPUE値は単位釣り機が単位時間に捕獲したアカイカの重量を表している。
漁船ごとに釣り機の性能や数は異なり、操業を行う人間の釣り機を扱う技能によってもCPUEは変化する。
しかしすべての漁船に搭載される釣り機が同じ性能であり、操業を行う人間の技能も同じであると仮定すると、CPUE値はその海域での魚群の密度を反映する値であるとできる。
このことから、CPUE値は漁場予測において重要な値である。
また、この漁獲実績データは、HSIモデリング結果を可視化する際に漁を行った地点をマーキングするためにも使用する。
例えば、太平洋の漁獲実績を基に日本海での漁獲量を予測しようとしても、それぞれの漁獲に関連がないので、有効な予測をすることはできない。
漁を行った地点をマーキングすることで、HSIモデリングの有効な範囲を大まかに把握することができる。

\section{HSIモデルから漁獲量予測への変換}
先に説明したようにHSIはその地点が対象生物の生息地として適しているかどうかを0から1で数値化したモデルである。
一方、漁獲量を表すCPUEは単位釣り機が単位時間に捕獲した対象生物の重量である。
生息しやすい環境に対象生物が集まる、生息しやすい環境では対象生物の生存確率が上がるので生息しやすい環境では対象生物の数が多くなると考えられる。
対象生物の数が多くなると、一般には対象生物のCPUEが高くなる。
そのためHSI値とCPUEが比例関係にあると仮定することで漁獲予測に関する過去の研究が行われてきた。
HSI=0の時は対象生物がおらずCPUE=0となり、HSI=1の時は対象生物が最大数おりCPUE=maxとなるとすると、その変換は式\ref{eq:3-0}で行うことができる。

\begin{eqnarray}
\label{eq:3-0}
PredictedCPUE &=& (maxCPUE-0) \times HSI \\
&=& maxCPUE \times HSI
\end{eqnarray}

PredictedCPUEは漁獲量予測、maxCPUEは観測された最大CPUEである。
本研究ではHSIとCPUEの変換をこの式で行う。

\section{SIモデル}
漁獲量を単一の海洋環境変数から説明するモデルがSIモデルである。以下ではSIモデル構築手法と提案手法を説明し、その違いを述べる。

\if0
まだそれぞれの手法の違いがはっきりとわかるように説明してない
\fi

\subsection{従来手法によるSIモデル構築}
従来手法でのSIモデル構築は次の手順で行う。
まず、SIモデルを構築したい変数について、深さインデックスを一つ選ぶ。
実測した漁獲点から垂直に見た時の深さインデックスでの変数値と、その漁獲点でのCPUEを散布図に描点する。
次に平滑化パラメータを一つ設定し、散布図を平滑化スプラインで近似する。
スプライン曲線は制御点付近を通る滑らかな曲線で、制御点が作る各区間ごとに多項式を立てている。
制御点$(x_i , y_i )$さえ与えれば全ての制御点を通るスプライン曲線を生成できるがそのままだと全ての点を必ず通る曲線が生成され、モデルの頑強性が低くなる問題が起きる。
それを回避するために従来手法では制御点の他に平滑化パラメータを導入したスプライン曲線生成手法を用いている。
N個の制御点$(x_i , y_i )$が与えられている場合、次式\ref{eq:3-49}の$\sigma$が最小になる(2M-1)次のスプライン曲線$f(x)$が自然スプラインである。

\begin{eqnarray}
\label{eq:3-49}
\sigma = \sum_{i=0}^{N-1} w_i ( f(x_i ) - y_i )^2 + g \int_{x_{0}}^{x_{N-1}} (f^{(M)}(x))^2 dx
\end{eqnarray}

この式は制御点とスプライン曲線との二乗誤差 + スプライン曲線の急峻さを意味し、それが最小となる曲線を自然スプラインとする。
自然スプライン$f(x)$は式\ref{eq:3-50}で定義される切断べき関数を用いて、式\ref{eq:3-51}で表せる。

\begin{eqnarray}
\label{eq:3-50}
(x-x_i )_{+}^{M} = \left\{ \begin{array}{ll}
0 & x<x_i \\
(x-x_i )^{M} & x_i < x
\end{array}
\right.
\end{eqnarray}

\begin{eqnarray}
\label{eq:3-51}
f(x) = \sum_{i=0}^{M-1} a_i x^i + \sum_{i=0}^{N-1}c_i (x-x_{i})_{+}^{2M-1}
\end{eqnarray}

式\ref{eq:3-51}で使用した定数$c_i$は次式を満たす。

\begin{eqnarray}
\label{eq:3-52}
f(x_j) + (-1)^{M} g(2M-1)! c_j w_{j}^{-1} = y_j & (j=0,1,\cdots , N-1)
\end{eqnarray}

ここでi番目とi+1番目の制御点による区間でのM階の差分商を$N_{i}(x)$とする。
また、式\ref{eq:3-53}で$P_{i,j}(x_j)$を定義する。

\begin{eqnarray}
\label{eq:3-53}
P_{i,j}(x_j) = \prod_{k=i}^{i+M} (x_{j} - x_{k})
\end{eqnarray}

この$P_{i,j}(x_j)$を使って$N_{i}(x)$は次式となる。

\begin{eqnarray}
\label{eq:3-54}
N_{i}(x) = \sum_{j=i}^{i+M} \frac{(x-x_{i})_{+}^{2M-1}}{P_{i,j}(x_j)}
\end{eqnarray}

$N_{i}(x)$を使って式\ref{eq:3-55}の自然スプラインを構築できる。

\begin{eqnarray}
\label{eq:3-55}
\sum_{i=0}^{M-1} a_i x^i + \sum_{i=0}^{N-M-1}b_i N_{i}(x)
\end{eqnarray}

式\ref{eq:3-55}と式\ref{eq:3-51}を比較すると次式が成り立つ。

\begin{eqnarray}
0 \leq l < Mの時  c_i = \sum_{i=1}^{l} \frac{b_i}{P_{i,l}(x_l)} \\
M \leq l < N-Mの時  c_i = \sum_{i=l-m}^{l} \frac{b_i}{P_{i,l}(x_l)} \\
N-M \leq l < Nの時  c_i = \sum_{i=l-m}^{N-M-1} \frac{b_i}{P_{i,j}(x_l)} 
\end{eqnarray}

式\ref{eq:3-51}の第一項はxについての(2M-1)次の式なので、(2M)次の差分商は0になる。
これを使って式\ref{eq:3-52}の(2M)次差分商は式\ref{eq:3-56}となる。
ただし$N_{ij}^{*}$は$b_i$と$x_j$を含まない式で、$\delta$はyの2M次の差分商である。

\begin{eqnarray}
\label{eq:3-56}
\sum_{i=0}^{N-M-1} b_i N_{ij}^{*} x_j = \delta (x_j) & ただし(j=0,1,2\cdots , N-M-1)
\end{eqnarray}

この式で未知数$b_i$の数はN-M-1個、それに対して式がN-M-1個あるので未知数$b_i$を決定できる。
その後式\ref{eq:3-55}と式{ref:eq:3-51}を比較した式から$c_i$が決定できる。
これによって自然スプラインを構築できる。

この自然スプラインを用いて従来手法でのSIモデル構築を行う。

次にその構築例を示す。

\if0
スプラインの説明
\fi
図\ref{fig:3.1}は2006年2月の漁獲点データ184点を用いてそれぞれの漁獲点でのCPUEを縦軸、その漁獲点での深さ0.5mでの塩分濃度を横軸とし、散布図を描いている。
またさらに平滑化パラメータ=0.5に設定したスプライン曲線を重ねており、これを散布図の近似曲線として扱う。
深さインデックスの選択と、平滑化パラメータの設定を繰り返し、利用者が最適と判断したスプライン曲線をSIモデルとする。
図\ref{fig:3.2}は同じように散布図を描いているが、平滑化パラメータ=0.999に設定したスプライン曲線を重ねている。
このように海洋環境変数の分布が同じでも平滑化パラメータの設定によって近似曲線が大きく変化する。
また、スプライン曲線がオーバーフィッティングしているのかアンダーフィッテングしているのかの明確な指標はなく、そのため利用者は最適な平滑化パラメータの設定を見て確認し決定する必要がある。
これを変数ごとに行うことで、各SIモデルを構築する。
この手法でSIモデルを構築する場合、変数値とCPUEの散布図を作成する時点で漁獲を行った時刻の情報が失われる。
そのためSIモデルの時間変化を考慮することができない。
そこで、SIモデルが変化しないと仮定しても問題ない程度に短い時間幅でモデルを構築する必要がある。

\begin{figure}
  \begin{center}
    \includegraphics[width=7cm]{3-1.png}
  \end{center}
  \caption{2006年2月の漁獲点における塩分濃度とCPUEの散布図と、スプライン係数=0.5に設定したスプライン曲線による近似曲線}
  \label{fig:3.1}
\end{figure}

\begin{figure}
  \begin{center}
    \includegraphics[width=7cm]{3-2.png}
  \end{center}
  \caption{2006年2月の漁獲点における塩分濃度とCPUEの散布図と、スプライン係数=0.999に設定したスプライン曲線による近似曲線}
  \label{fig:3.2}
\end{figure}

次の変数でも同様に深さインデックスを選び直しスプライン曲線で近似する。
こうすることで5種のSIモデルを構築できる。

式\ref{eq:3-49}に表れているように従来のSIモデル構築手法では頑強性を高める工夫を行う。
そこで提案手法でも同じ目的の工夫を行う。